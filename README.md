# Edge AI Motor Anomaly Detection on STM32H745ZI

A dual-core (CM7/CM4) embedded system that detects electric motor anomalies on-device using a 3-axis accelerometer and an int8 neural network. CM4 acquires data and shares it via a ring buffer in D2 SRAM; CM7 runs inference using X-CUBE-AI and drives LED/buzzer feedback.

## Features
- STM32H745ZI dual-core architecture (CM7 inference, CM4 acquisition)
- MSA301 3-axis accelerometer over I²C
- QSPI NOR flash (W25Q256JV) for logs/models
- TIM6-based 1 kHz data collection for AI dataset capture
- Quantized (int8) CNN deployed via STM32Cube.AI (X-CUBE-AI)
- Shared D2 SRAM ring buffer (.shared_ram) for inter-core exchange
- LED/buzzer feedback for anomaly indication
- Python pipeline for data collection, preprocessing, training, quantization

## Repository Structure
├─ CM4/ # Cortex-M4 project (acquisition, ring buffer, 1 kHz capture)
│ ├─ Core/
│ ├─ STM32H745ZITX_FLASH.ld
│ └─ STM32H745ZITX_RAM.ld # .shared_ram mapped to D2
├─ CM7/ # Cortex-M7 project (inference, feedback)
│ ├─ Core/
│ ├─ X-CUBE-AI/App/ # Generated by STM32Cube.AI
│ ├─ STM32H745ZITX_FLASH.ld
│ └─ STM32H745ZITX_RAM.ld # .shared_ram mapped to D2
├─ Common/ # Dual-core boot helpers
├─ Drivers/, Middlewares/ # HAL, FreeRTOS, AI libs
├─ python_ai_pipeline/ # Data collection/training/export
│ ├─ data_collector.py
│ ├─ data_preprocessor.py
│ ├─ dataset_loader.py
│ ├─ model_trainer.py
│ └─ requirements.txt
├─ collected_data/ # CSV + JSON metadata per fault class
## System Architecture
- CM4: probes/configures MSA301, acquires frames `{x,y,z,ts}`, pushes to a `shared_ring` in `.shared_ram`.
- CM7: pops windows (60×3), z-score normalizes using embedded mean/std, quantizes to int8 (scale=0.0253386665, zp=12), runs inference, maps class to outputs.

## Build Instructions
1) Prerequisites:
- STM32CubeIDE 1.16+ and ST-LINK V3
- Python 3.10+ (for AI pipeline)

2) Firmware:
- Build and flash CM7, then CM4 (CM7 initializes clocks/boot handshake).
- Ensure both linkers define the `.shared_ram` section in D2 SRAM (0x30000000).

3) AI Model:
- Train and export:
```bash
cd python_ai_pipeline
python -m venv .venv
# Windows PowerShell
. .\.venv\Scripts\Activate.ps1
pip install -r requirements.txt
python model_trainer.py --data ..\collected_data --window 2.0 --step 0.5
```
- Import `models/motor_cnn_int8.tflite` into STM32Cube.AI (X-CUBE-AI) and generate code into `CM7/X-CUBE-AI/App/`.

## Runtime and Controls
- CM4:
  - AcquisitionTask: periodic read for live inference
  - AIDataCollectionTask (optional): TIM6 1 kHz capture for training; USB-CDC command set:
    - `START_NORMAL`, `START_IMBALANCE`, `START_BEARING`, `START_MISALIGN`, `STOP`, `GET_DATA`, `STATUS`, `RESET`

- CM7:
  - AiTask: pops frames, preprocesses, runs inference, toggles LED/buzzer for non-normal classes

## Shared Memory
- `shared_ring` is defined in CM4, placed into `.shared_ram` (D2, 32-byte aligned).
- CM7 includes a mirror header, references it as `extern volatile`.

## Normalization & Quantization
- Input int8: scale=0.0253386665, zp=12 (embedded in `AiTask`)
- Output int8 softmax: scale=1/256, zp=-128
- Update mean/std from `models/normalization_stats.json` after training.

## Troubleshooting
- No CM7 inference: confirm X-CUBE-AI generated files and correct input shape (60×3 int8)
- No inter-core data: validate `.shared_ram` in both linkers and volatile declaration
- Syscall warnings on CM4: benign with newlib-nano (stubs for `_write`, `_read`, etc.)
- USB timing: reduce chunk size or add delays when streaming samples

## Licensing
- STM32 HAL, FreeRTOS, and STM32Cube.AI licenses apply.
- Python scripts and firmware code under permissive terms (adjust to your preference).
